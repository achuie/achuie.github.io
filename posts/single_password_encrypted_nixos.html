<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Single-Password Encrypted NixOS &ndash; AH</title>
  <link rel="shortcut icon" type="image/jpg" href="https://media.githubusercontent.com/media/achuie/achuie.github.io/master/images/columns.jpg"/>
  <link rel="stylesheet" type="text/css" media="all" href="../css/style.css"/>
</head>
<div class="wrapper"><div class="content columns"><div class="column is-one-fifth"><div class="my-navbar"><img alt="Icon" src="https://media.githubusercontent.com/media/achuie/achuie.github.io/master/images/columns.jpg" style="width: 6vmax; vertical-align: middle;"/> <br/>
<a class="navlink" href="../index.html">home</a> <br/>
<a class="navlink" href="../pages/transient-comprehension.html">"blog"</a> <br/>
<a class="navlink" href="../pages/interests.html">interests</a></div></div>
<div class="column"><div class="main"><div id="doc" class="container"><h1>Single-Password Encrypted NixOS</h1><p>I recently installed NixOS on my home workstation/server. I‚Äôve only put <code>/home</code> on ZFS instead of going full root on ZFS, mainly because I didn‚Äôt want to deal with swap on ZFS and the root SSD would have been the odd drive out in a ZFS mirror anyway, so I figured I might as well go with BTRFS+LUKS-on-LVM to try out all the new-to-me technologies at once. I found some <a class="bodylink" href="https://astrid.tech/2021/12/17/0/two-disk-encrypted-zfs/">pretty</a> <a class="bodylink" href="https://blog.kolaente.de/2021/11/installing-nixos-with-encrypted-btrfs-root-device-and-home-manager-from-start-to-finish/">good</a> <a class="bodylink" href="https://gist.github.com/ladinu/bfebdd90a5afd45dec811296016b2a3f">guides</a>, but there were some steps that were different so I wanted to write down what I did for future reference.</p><h2>Installation Media</h2><p>As always, we start by creating a bootable disk. Below is my normal go-to:</p><pre><code># dd bs=4M if=path/to/nixos-minimal-version-x86_64-linux.iso of=/dev/disk/by-id/usb-My_flash_drive conv=fsync oflag=direct status=progress</code></pre><h2>Formatting the Drives</h2><p>Boot from the disk we just created. Ethernet should already be set up, but wifi requires extra steps:</p><pre><code># wpa_passphrase $SSID $PASSWORD &gt;/etc/wpa_supplicant.conf <br/># systemctl start wpa_supplicant</code></pre><p>Identify your drives (<code>fdisk -l</code>), and start with what will be the OS drive. Run <code>gdisk</code> on it, no partition numbers since we‚Äôll be using the whole drive.</p><pre><code># gdisk /dev/$DISK</code></pre><p>Instead of <code>/boot</code> and <code>/root</code> partitions, we‚Äôll create a partition for just the EFI</p><h6><p>‚Äî</p><p>NOTES</p></h6><p>https://discourse.nixos.org/t/systemd-boot-root-zfs-native-zfs-encryption-with-keylocation-file/26446 - details boot stage 1 initrd secret files - zfs keylocation=file:// must be accessible during the stage when the system attempts to mount the pool - our case is different, as attached storage with mountpoints is mounted during stage 2</p><p>https://gist.github.com/ladinu/bfebdd90a5afd45dec811296016b2a3f - the main guide - does not say about stage 2 key availability</p><p>https://jrs-s.net/2018/08/17/zfs-tuning-cheat-sheet/ - zfs tuning reference</p><p>https://discourse.nixos.org/t/how-to-run-init-stage-2-manually/38625 - info about stage 2 root path</p><p>https://astrid.tech/2021/12/17/0/two-disk-encrypted-zfs/ - guide with multiple zpools - some info about keylocation</p><p>https://old.reddit.com/r/zfs/comments/bnvdco/zol_080_encryption_dont_encrypt_the_pool_root/ - future work</p></div></div></div></div>
<footer class="footer"><div class="content"><span class="footer-separator">ùÑΩ</span> <br/> <br/>
<a class="bodylink" href="https://github.com/achuie">GitHub</a>
<a class="bodylink" href="https://www.instagram.com/achooie42">Instagram</a>
<a class="bodylink" href="../pages/about.html">About</a> <br/>
Made with
<a class="bodylink" href="https://git.matthewbutterick.com/mbutterick/pollen">Pollen</a> and
<a class="bodylink" href="https://bulma.io">Bulma</a></div></footer></div>
</html>
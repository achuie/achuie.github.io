<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Single-Password Encrypted NixOS &ndash; AH</title>
  <link rel="shortcut icon" type="image/jpg" href="https://media.githubusercontent.com/media/achuie/achuie.github.io/master/images/columns.jpg"/>
  <link rel="stylesheet" type="text/css" media="all" href="../css/style.css"/>
</head>
<div class="wrapper"><div class="content columns"><div class="column is-one-fifth"><div class="my-navbar"><img alt="Icon" src="https://media.githubusercontent.com/media/achuie/achuie.github.io/master/images/columns.jpg" style="width: 6vmax; vertical-align: middle;"/> <br/>
<a class="navlink" href="../index.html">home</a> <br/>
<a class="navlink" href="../pages/transient-comprehension.html">"blog"</a> <br/>
<a class="navlink" href="../pages/interests.html">interests</a></div></div>
<div class="column"><div class="main"><div id="doc" class="container"><h1>Single-Password Encrypted NixOS</h1><p>I recently installed NixOS on my homelab. I found some <a class="bodylink" href="https://astrid.tech/2021/12/17/0/two-disk-encrypted-zfs/">pretty</a> <a class="bodylink" href="https://blog.kolaente.de/2021/11/installing-nixos-with-encrypted-btrfs-root-device-and-home-manager-from-start-to-finish/">good</a> <a class="bodylink" href="https://gist.github.com/ladinu/bfebdd90a5afd45dec811296016b2a3f">guides</a>, but there were some steps that were different so I wanted to write down what I did for future reference.</p><p>I’ve only put <code>/home</code> on ZFS instead of going full root on ZFS, mainly because I didn’t want to deal with swap on ZFS and the root SSD would have been the odd drive out in a ZFS mirror anyway, so I figured I might as well go with BTRFS+LVM-on-LUKS to try out all the new-to-me technologies at once.</p><h2>Create the Installation Media</h2><p>As always, we start by creating a bootable disk. Below is my normal go-to:</p><pre><code># dd bs=4M if=path/to/nixos-minimal-version-x86_64-linux.iso of=/dev/disk/by-id/usb-My_flash_drive
conv=fsync oflag=direct status=progress</code></pre><h2>Partition the Root Drive</h2><p>Boot from the disk we just created. Ethernet should already be set up, but wifi requires extra steps:</p><pre><code># wpa_passphrase $SSID $PASSWORD &gt;/etc/wpa_supplicant.conf
# systemctl start wpa_supplicant</code></pre><p>Identify our drives (<code>fdisk -l</code>), and start with what will be the OS drive. Run <code>gdisk</code> on it, no partition numbers since we’ll be using the whole drive.</p><pre><code># gdisk /dev/$DISK</code></pre><p>Instead of the normal <code>/boot</code> partition, we’ll create a partition for just the EFI bootloader entries mounted at <code>/boot/efi</code>. That way we can keep the kernel images encrypted. Create the ESP with size anywhere from <code>550Mb</code> to <code>1Gb</code>, and with type <code>ef00</code>. The <code>/</code> partition can use the rest of the space on the drive and should be type <code>8300</code>.</p><h2>Generate the Volume Keys</h2><p>So far we’ve only dealt with the root drive. The home drive will be ZFS, so the partitioning and formatting are done together. We’ll use keyfiles to decrypt each drive, and both keys will be stored on the root drive. LUKS supports encryption with both a key and a password, so GRUB can initially prompt us for the password, then NixOS can include the keyfile in the initial ramdisk for Stage 1 of the boot process to use. First, we’ll generate a random, four kilobyte keyfile for LUKS:</p><pre><code># dd if=/dev/urandom of=./keyfile0.bin bs=1024 count=4</code></pre><p>and then a random key for ZFS, which requires a thirty-two byte keyfile:</p><pre><code># dd if=/dev/urandom of=./keyfile1.bin bs=32 count=1</code></pre><h2>Format the Drives</h2><h3>OS Drive</h3><p>Let’s set up the root partition. LUKS first; the password we set here will be the one needed at boot:</p><pre><code># cryptsetup luksFormat–type luks1 -c aes-xts-plain64 -s 256 -h sha512 /dev/${DISK}2
# cryptsetup luksAddKey /dev/${DISK}2 keyfile0.bin
# cryptsetup luksOpen /dev/${DISK}2 root–key-file keyfile0.bin</code></pre><p>We need to use LUKS version 1 in order to work with GRUB. Also, we’re using GRUB instead of systemd-boot because GRUB is able to work with an encrypted <code>/boot</code> (as long as <code>/boot/efi</code> is unencrypted). Now, we set up LVM:</p><pre><code># pvcreate /dev/mapper/root
# vgcreate vg /dev/mapper/root
# lvcreate -L 8G -n swap vg
# lvcreate -l ‘100%FREE’ -n root vg</code></pre><p>Now we can format each logical volume. We’ll start with swap, and activate it:</p><pre><code># mkswap /dev/mapper/vg-swap
# swapon /dev/mapper/vg-swap</code></pre><p>Now the root volume:</p><pre><code># mkfs.btrfs -L root /dev/mapper/vg-root</code></pre><p>And the EFI partition:</p><pre><code># mkfs.vfat -n boot /dev/${DISK}1</code></pre><h3>Home Drive</h3><p>First we need to identify our disks in a persistent way. We’ll use <code>/dev/disk/by-id</code> for this. We can get around having to deal with the unique IDs with the following:</p><pre><code>$ DISKS=$(ls /dev/disk/by-id/ata-TOSHIBA_* | grep -v ‘part’ | tr ‘\n’ ' ’)</code></pre><p>Now we can assemble the ZFS options for our pool. I consulted this <a class="bodylink" href="https://jrs-s.net/2018/08/17/zfs-tuning-cheat-sheet/">older guide</a>, which still seemed applicable, and created the pool as below:</p><pre><code># zpool create -O encryption=on -O keyformat=raw -O keylocation=file:///mnt-root/etc/secrets/initrd/keyfile1.bin
-O compression=zstd -O mountpoint=none -O xattr=sa -O acltype=posix -O atime=off -O secondarycache=none -o ashift=12
ztank mirror $DISKS</code></pre><h6>—

NOTES</h6><p>$ DISKS=$(ls /dev/disk/by-id/ata-TOSHIBA_MN06ACA10T_14K0A06* | grep -v ‘part’ | tr ‘\n’ ' ’) # zpool create -O encryption=on -O keyformat=raw -O keylocation=file:///mnt-root/etc/secrets/initrd/keyfile1.bin -O compression=zstd -O mountpoint=none -O xattr=sa -O acltype=posix -O atime=off -O secondarycache=none -o ashift=12 ztank mirror $DISKS -f # zfs create -o mountpoint=legacy ztank/home</p><p># mkdir volkeys # mv mnt-root/etc/secrets/initrd/keyfile1.bin volkeys/ # zfs set keylocation=file:///volkeys/keyfile1.bin ztank</p><p>https://discourse.nixos.org/t/systemd-boot-root-zfs-native-zfs-encryption-with-keylocation-file/26446 - details boot stage 1 initrd secret files - zfs keylocation=file:// must be accessible during the stage when the system attempts to mount the pool - our case is different, as attached storage with mountpoints is mounted during stage 2</p><p>https://gist.github.com/ladinu/bfebdd90a5afd45dec811296016b2a3f - the main guide - does not say about stage 2 key availability</p><p>https://jrs-s.net/2018/08/17/zfs-tuning-cheat-sheet/ - zfs tuning reference</p><p>https://discourse.nixos.org/t/how-to-run-init-stage-2-manually/38625 - info about stage 2 root path</p><p>https://astrid.tech/2021/12/17/0/two-disk-encrypted-zfs/ - guide with multiple zpools - some info about keylocation</p><p>https://old.reddit.com/r/zfs/comments/bnvdco/zol_080_encryption_dont_encrypt_the_pool_root/ - future work</p></div></div></div></div>
<footer class="footer"><div class="content"><span class="footer-separator">䷁ ䷷ ䷀</span> <br/> <br/>
<a class="bodylink" href="https://github.com/achuie">GitHub</a>
<a class="bodylink" href="https://www.instagram.com/achooie42">Instagram</a>
<a class="bodylink" href="../pages/about.html">About</a> <br/>
Made with
<a class="bodylink" href="https://git.matthewbutterick.com/mbutterick/pollen">Pollen</a> and
<a class="bodylink" href="https://bulma.io">Bulma</a></div></footer></div>
</html>